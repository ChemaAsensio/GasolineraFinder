<div class="home-container">

  <!-- MODE SWITCH -->
  <div class="mode-switch" role="tablist" aria-label="Modo de bÃºsqueda">
    <button
      type="button"
      class="mode-pill"
      [class.active]="modoSeleccionado === 'buscar'"
      (click)="setModo('buscar')"
      aria-pressed="{{ modoSeleccionado === 'buscar' }}"
    >
      Buscar Gasolineras
    </button>

    <button
      type="button"
      class="mode-pill"
      [class.active]="modoSeleccionado === 'ruta'"
      (click)="setModo('ruta')"
      aria-pressed="{{ modoSeleccionado === 'ruta' }}"
    >
      Gasolineras en Ruta
    </button>
  </div>

  <!-- CARD PERFIL -->
  <section class="perfil-card">
    <div class="perfil-container">
      <!-- Datos del perfil -->
      <div class="datos-perfil">
        <h2>Perfil de Usuario</h2>
        <p><strong>Nombre:</strong> <span> Carlos</span></p>
        <p><strong>Marca del coche:</strong> <span> BMW</span></p>
        <p><strong>Modelo:</strong> <span> M4 GTS 2016</span></p>
        <p><strong>Consumo:</strong> <span> 6.5 L/100km</span></p>
      </div>

      <!-- Video coche -->
      <div class="gif-coche">
        <video
          src="assets/2016_bmw_m4_gts.webm"
          autoplay
          muted
          playsinline
        ></video>
      </div>
    </div>
  </section>

  <!-- ACORDEÃ“N: UbicaciÃ³n de Inicio -->
  <div class="acordeon-mejorado" [class.cerrado]="!acordeonAbierto.inicio">
    <div class="acordeon-cabecera" (click)="toggleAcordeon('inicio')">
      <div class="acordeon-titulo">
        <div class="acordeon-icono-grande">
          <span class="icono">ğŸ </span>
        </div>
        <div class="acordeon-texto">
          <h3>Inicio</h3>
        </div>
      </div>
      <div class="acordeon-flecha" [class.abierto]="acordeonAbierto.inicio">
        <span>â–¼</span>
      </div>
    </div>

    <div class="acordeon-contenido" *ngIf="acordeonAbierto.inicio">
      <div class="contenido-interior">
        <div class="direccion-container">
          <div class="campos-grid">
            <div class="campo-direccion">
              <label for="calleInicio">ğŸ“ Calle:</label>
              <input id="calleInicio" [(ngModel)]="ubicacionUsuario.calle" placeholder="Ej: Gran VÃ­a" />
            </div>

            <div class="campo-direccion">
              <label for="numeroInicio">ğŸ”¢ NÃºmero:</label>
              <input id="numeroInicio" [(ngModel)]="ubicacionUsuario.numero" placeholder="Ej: 28" />
            </div>

            <div class="campo-direccion">
              <label for="ciudadInicio">ğŸ™ï¸ Ciudad:</label>
              <input id="ciudadInicio" [(ngModel)]="ubicacionUsuario.ciudad" placeholder="Ej: Madrid" />
            </div>

            <div class="campo-direccion">
              <label for="provinciaInicio">ğŸ—ºï¸ Provincia:</label>
              <input id="provinciaInicio" [(ngModel)]="ubicacionUsuario.provincia" placeholder="Ej: Madrid" />
            </div>
          </div>

          <div class="botones-accion-container">
            <button (click)="obtenerUbicacion()" class="btn-ubicacion-elegante" title="Detectar mi ubicaciÃ³n automÃ¡ticamente">
              <span class="btn-ubicacion-icono">ğŸ“</span>
              <span class="btn-ubicacion-texto">Mi ubicaciÃ³n</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ACORDEÃ“N: UbicaciÃ³n de Destino (solo modo ruta) -->
  <div
    class="acordeon-mejorado"
    *ngIf="modoSeleccionado === 'ruta'"
    [class.cerrado]="!acordeonAbierto.destino"
  >
    <div class="acordeon-cabecera" (click)="toggleAcordeon('destino')">
      <div class="acordeon-titulo">
        <div class="acordeon-icono-grande">
          <span class="icono">ğŸ¯</span>
        </div>
        <div class="acordeon-texto">
          <h3>Destino</h3>
        </div>
      </div>
      <div class="acordeon-flecha" [class.abierto]="acordeonAbierto.destino">
        <span>â–¼</span>
      </div>
    </div>

    <div class="acordeon-contenido" *ngIf="acordeonAbierto.destino">
      <div class="contenido-interior">
        <div class="direccion-container">
          <div class="campos-grid">
            <!-- Campos para la direcciÃ³n de destino -->
            <div class="campo-direccion">
              <label for="calleDestino">ğŸ“ Calle:</label>
              <input id="calleDestino" [(ngModel)]="destino.calle" placeholder="Ej: Avenida Diagonal" />
            </div>

            <div class="campo-direccion">
              <label for="numeroDestino">ğŸ”¢ NÃºmero:</label>
              <input id="numeroDestino" [(ngModel)]="destino.numero" placeholder="Ej: 407" />
            </div>

            <div class="campo-direccion">
              <label for="ciudadDestino">ğŸ™ï¸ Ciudad:</label>
              <input id="ciudadDestino" [(ngModel)]="destino.ciudad" placeholder="Ej: Barcelona" />
            </div>

            <div class="campo-direccion">
              <label for="provinciaDestino">ğŸ—ºï¸ Provincia:</label>
              <input id="provinciaDestino" [(ngModel)]="destino.provincia" placeholder="Ej: Barcelona" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ACORDEÃ“N: Filtros -->
  <div class="acordeon-mejorado" [class.cerrado]="!acordeonAbierto.filtros">
    <div class="acordeon-cabecera" (click)="toggleAcordeon('filtros')">
      <div class="acordeon-titulo">
        <div class="acordeon-icono-grande">
          <span class="icono">âš™ï¸</span>
        </div>
        <div class="acordeon-texto">
          <h3>Filtros</h3>
        </div>
      </div>
      <div class="acordeon-flecha" [class.abierto]="acordeonAbierto.filtros">
        <span>â–¼</span>
      </div>
    </div>

    <div class="acordeon-contenido" *ngIf="acordeonAbierto.filtros">
      <div class="contenido-interior">
        <!-- âœ… AutonomÃ­a -->
        <div class="campo-direccion">
          <label for="kmDisponiblesUsuario">ğŸ”‹ AutonomÃ­a (km):</label>
          <input
            id="kmDisponiblesUsuario"
            type="number"
            [(ngModel)]="kmDisponiblesUsuario"
            placeholder="Ej: 500"
          />
        </div>

        <app-filters
          [empresasDisponibles]="empresasDisponibles"
          [filters]="filters"
          (filterChange)="onFiltersCambiados($event)"
        ></app-filters>
      </div>
    </div>
  </div>

  <!-- BOTÃ“N DE BÃšSQUEDA -->
  <div class="botones-busqueda-container">
    <button
      (click)="ejecutarBusqueda()"
      class="btn-busqueda-principal"
      [class.cargando]="busquedaEnCurso"
      [disabled]="busquedaEnCurso">
      <span class="btn-busqueda-icono">{{ busquedaEnCurso ? 'â³' : 'ğŸ”' }}</span>
      <span class="btn-busqueda-texto">
        {{ busquedaEnCurso ? 'Buscando...' : 'Buscar gasolineras' }}
        <span *ngIf="!busquedaEnCurso && mostrarResultados && gasolinerasFiltradas.length > 0" class="contador-preview"></span>
      </span>
    </button>
  </div>

  <!-- âœ… MAPA (despuÃ©s de "buscar gasolineras") -->
  <section class="map-card">
    <div class="map-header">
      <h3>ğŸ—ºï¸ Mapa</h3>
      <p class="map-subtitle">
        Origen (ğŸ ), destino (ğŸ¯) y selecciÃ³n (â­).
      </p>
    </div>

    <google-map
      width="100%"
      height="360px"
      [center]="mapCenter"
      [zoom]="mapZoom"
      [options]="mapOptions"
     >
      <!-- Origen -->
      <map-marker
        *ngIf="markerOrigen"
        [position]="markerOrigen"
        [label]="'ğŸ '"
        [title]="'Origen'"
      ></map-marker>

      <!-- Destino -->
      <map-marker
        *ngIf="markerDestino"
        [position]="markerDestino"
        [label]="'ğŸ¯'"
        [title]="'Destino'"
      ></map-marker>

      <!-- SelecciÃ³n -->
      <map-marker
        *ngIf="markerSeleccion"
        [position]="markerSeleccion"
        [label]="'â­'"
        [title]="'Gasolinera seleccionada'"
      ></map-marker>

      <!-- âœ… PolilÃ­nea de la ruta -->
      <map-polyline
       *ngIf="routePath?.length"
       [path]="routePath"
       [options]="routePolylineOptions">
      </map-polyline>

       <!-- âœ… Markers gasolineras (estrella) -->
      <map-marker
       *ngFor="let m of stationMarkers"
        #mkr="mapMarker"
        [position]="m.position"
        [options]="stationMarkerOptions"
        [title]="m.title"
        (mapClick)="onStationMarkerClick(mkr, m.station)">
      </map-marker> 



    </google-map>
  </section>

  <!-- ACORDEÃ“N: Resultados -->
  <div class="acordeon-mejorado"
       id="resultados-container"
       *ngIf="mostrarResultados"
       [class.cerrado]="!acordeonAbierto.resultados">

    <div class="acordeon-cabecera" (click)="toggleAcordeon('resultados')">
      <div class="acordeon-titulo">
        <div class="acordeon-icono-grande">
          <span class="icono">â›½</span>
        </div>
        <div class="acordeon-texto">
          <h3>Resultados</h3>
        </div>
      </div>
      <div class="acordeon-flecha" [class.abierto]="acordeonAbierto.resultados">
        <span>â–¼</span>
      </div>
    </div>

    <div class="acordeon-contenido" *ngIf="acordeonAbierto.resultados">
      <div class="contenido-interior">

        <!-- Mensajes de estado dentro del acordeÃ³n -->
        <div *ngIf="cargando" class="estado-cargando">
          <p>Cargando gasolineras...</p>
        </div>

        <div *ngIf="error" class="estado-error">
          <p>âŒ {{ error }}</p>
        </div>

        <div *ngIf="!cargando && !error && gasolinerasFiltradas.length === 0" class="estado-vacio">
          <p>ğŸ“­ No se encontraron gasolineras con los filtros aplicados</p>
          <button (click)="restablecerFiltros()" class="btn-secundario">
            Restablecer filtros
          </button>
        </div>

        <!-- âœ… Resultados (pinta TODO summary-box) -->
        <div *ngIf="!cargando && !error && gasolinerasFiltradas.length > 0">
          <app-summary-box
            [stations]="gasolinerasFiltradas"
            [filters]="filters"
            [ubicacionUsuario]="ubicacionUsuario"
            [modo]="modoSeleccionado">
          </app-summary-box>
        </div>

      </div>
    </div>

  </div>

  <!-- BotÃ³n Restablecer todo -->
  <div class="restablecer-container">
    <button (click)="restablecerTodo()" class="btn-restablecer-todo">
      ğŸ”„ Restablecer todo
    </button>
  </div>

  <!-- BotÃ³n Scroll to Top -->
  <button
    class="scroll-top-btn"
    [class.visible]="mostrarBotonScrollTop"
    (click)="scrollToTop()"
    aria-label="Volver arriba"
    title="Volver arriba">
    â†‘
  </button>

  <!-- ===========================
     ğŸ§ª DEPURACIÃ“N (MODO RUTA) - MEJORADO
  =========================== -->
  <section class="debug-panel" *ngIf="DEBUG_UI">
    <h3>ğŸ§ª DepuraciÃ³n (Modo Ruta)</h3>
    
    <div class="debug-header">
      <div class="debug-status"
           [class.running]="debugRuta.status === 'running'" 
           [class.done]="debugRuta.status === 'done'" 
           [class.error]="debugRuta.status === 'error'">
        <strong>Estado:</strong> {{ debugRuta.status }}
      </div>
      <div class="debug-time">
        <strong>Tiempo:</strong> {{ debugRuta.elapsedMs }} ms
      </div>
    </div>

    <!-- Mostrar informaciÃ³n clave de inmediato -->
    <div class="debug-summary" *ngIf="debugRuta.dataset.totalStations > 0">
      <h4>ğŸ“Š Resumen</h4>
      <div class="summary-grid">
        <div class="summary-item">
          <span class="label">Gasolineras totales:</span>
          <span class="value">{{ debugRuta.dataset.totalStations }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Filtradas:</span>
          <span class="value">{{ debugRuta.dataset.afterDatasetFilters }}</span>
        </div>
        <div class="summary-item">
          <span class="label">En corredor (total):</span>
          <span class="value">{{ debugRuta.dataset.corridorCandidatesTotal }}</span>
        </div>
        <div class="summary-item">
          <span class="label">En autonomÃ­a (corredor):</span>
          <span class="value">{{ debugRuta.dataset.corridorCandidatesEnAutonomia }}</span>
        </div>
      </div>
    </div>

    <!-- Botones para expandir/colapsar secciones -->
    <div class="debug-controls">
      <button type="button" (click)="toggleDebugSection('inputs')">
        {{ debugSections.inputs ? 'â–¼' : 'â–¶' }} 1) Entradas
      </button>
      <button type="button" (click)="toggleDebugSection('route')">
        {{ debugSections.route ? 'â–¼' : 'â–¶' }} 2) Ruta base
      </button>
      <button type="button" (click)="toggleDebugSection('dataset')">
        {{ debugSections.dataset ? 'â–¼' : 'â–¶' }} 3) Dataset y filtros
      </button>
      <button type="button" (click)="toggleDebugSection('googleCalls')">
        {{ debugSections.googleCalls ? 'â–¼' : 'â–¶' }} 4) Llamadas Google
      </button>
      <button type="button" (click)="toggleDebugSection('enriched')">
        {{ debugSections.enriched ? 'â–¼' : 'â–¶' }} 5) Resultados
      </button>
      <button type="button" (click)="toggleDebugSection('final')">
        {{ debugSections.final ? 'â–¼' : 'â–¶' }} 6) Top 3 final
      </button>
      <button type="button" (click)="toggleDebugSection('ui')">
        {{ debugSections.ui ? 'â–¼' : 'â–¶' }} 7) Estado UI
      </button>
    </div>

    <!-- Secciones colapsables -->
    <div *ngIf="debugSections.inputs" class="debug-section">
      <h4>1) Entradas</h4>
      <pre>{{ debugRuta.input | json }}</pre>
    </div>

    <div *ngIf="debugSections.route" class="debug-section">
      <h4>2) Ruta base</h4>
      <pre>{{ debugRuta.baseRoute | json }}</pre>
    </div>

    <div *ngIf="debugSections.dataset" class="debug-section">
      <h4>3) Dataset y filtros</h4>
      <div *ngIf="debugRuta.dataset.preRankTop.length > 0">
        <h5>Top pre-ranking (primeros 5):</h5>
        <ul>
          <li *ngFor="let item of debugRuta.dataset.preRankTop.slice(0, 5)">
            {{ item.rotulo }} - Dist: {{ item.minDistRuta | number:'1.2-2' }}km - Precio: {{ item.precio | number:'1.3-3' }}â‚¬
          </li>
        </ul>
      </div>
      <pre>{{ debugRuta.dataset | json }}</pre>
    </div>

    <div *ngIf="debugSections.googleCalls" class="debug-section">
      <h4>4) Llamadas "ruta con parada"</h4>
      <pre>{{ debugRuta.googleCalls | json }}</pre>
    </div>

    <div *ngIf="debugSections.enriched" class="debug-section">
      <h4>5) Resultados enriquecidos (tabla)</h4> 

      <div *ngIf="(debugRuta.enriched?.results?.length ?? 0) === 0">
        <em>No hay filas enriquecidas aÃºn.</em>
      </div>

      <div class="debug-table-wrap" *ngIf="(debugRuta.enriched?.results?.length ?? 0) > 0">
        <table class="debug-table">
          <thead>
            <tr>
              <th>#</th>
              <th>RÃ³tulo</th>
              <th>DirecciÃ³n</th>
              <th>Precio</th>
              <th>distToGas (km)</th>
              <th>distConParada (km)</th>
              <th>extraKm</th>
              <th>litrosExtra</th>
              <th>costeDesvÃ­o</th>
              <th>minDistRuta</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of debugRuta.enriched.results; let i = index">
              <td>{{ i + 1 }}</td>
              <td>{{ r.rotulo }}</td>
              <td>{{ r.direccion }}</td>
              <td>{{ r.precioLitro | number:'1.3-3' }}</td>
              <td>{{ r.distToGasKm | number:'1.2-2' }}</td>
              <td>{{ r.distConParadaKm | number:'1.2-2' }}</td>
              <td>{{ r.extraKmReal | number:'1.2-2' }}</td>
              <td>{{ r.litrosExtra | number:'1.3-3' }}</td>
              <td>{{ r.costeDesvio | number:'1.3-3' }}</td>
              <td>{{ r.minDistToRouteKm | number:'1.2-2' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div *ngIf="debugSections.final" class="debug-section">
      <h4>6) Top 3 final</h4>
      <div *ngIf="debugRuta.final.top3.length > 0">
        <h5>Resultados finales:</h5>
        <ul>
          <li *ngFor="let item of debugRuta.final.top3; let i = index">
            #{{ i + 1 }}: {{ item.rotulo }} - Precio: {{ item.precio | number:'1.3-3' }}â‚¬ - Extra: {{ item.extraKmReal | number:'1.2-2' }}km - Coste: {{ item.costeDesvio | number:'1.3-3' }}â‚¬
          </li>
        </ul>
      </div>
      <pre>{{ debugRuta.final | json }}</pre>
    </div>

    <div *ngIf="debugSections.ui" class="debug-section">
      <h4>7) Estado UI</h4>
      <pre>{{ debugRuta.ui | json }}</pre>
    </div>
  </section>

</div>
